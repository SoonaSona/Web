<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between mb-4 align-items-center">
        <h3 class="fw-bold mb-0 text-primary">
            <i class="bi bi-clipboard-pulse"></i> Nurse Station
        </h3>
        <div class="d-flex">
            <input id="search" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠..." style="width: 250px;">
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 text-primary"><i class="bi bi-people"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)</h5>
            <small class="text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 ps-3">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</th>
                            <th>HN</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏Ç‡πâ</th>
                            <th>Dx</th>
                            <th>Vitals ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                            <th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <% patients.forEach(function(p) { %>
                            <tr style="cursor: pointer;" onclick="openPatientData('<%= p.hn %>')">
                                <td class="ps-3"><span class="badge bg-info text-dark"><%= p.bed %></span></td>
                                <td><%= p.hn %></td>
                                <td class="fw-bold text-primary"><%= p.name %></td>
                                <td><%= p.doctor %></td>
                                <td><span class="badge bg-warning text-dark"><%= p.dx %></span></td>
                                <td class="small text-muted"><%= p.vitals %></td>
                                <td class="text-end pe-3">
                                    <button class="btn btn-sm btn-outline-primary rounded-pill">
                                        <i class="bi bi-eye"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <div>
                    <h5 class="modal-title fw-bold" id="modalTitle">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h5>
                    <small id="modalSubtitle" class="text-white-50">HN: ...</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <ul class="nav nav-tabs nav-justified" id="patientTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-profile-btn" data-bs-toggle="tab" data-bs-target="#tab-profile" type="button"><i class="bi bi-person-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-orders-btn" data-bs-toggle="tab" data-bs-target="#tab-orders" type="button"><i class="bi bi-prescription2"></i> ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-notes-btn" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button"><i class="bi bi-journal-text"></i> Nurse Note</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-meds-btn" data-bs-toggle="tab" data-bs-target="#tab-meds" type="button"><i class="bi bi-capsule"></i> Medication</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-labs-btn" data-bs-toggle="tab" data-bs-target="#tab-labs" type="button"><i class="bi bi-eyedropper"></i> ‡∏ú‡∏• Lab</button>
                    </li>
                </ul>

                <div class="tab-content p-4 bg-light" id="patientTabsContent" style="min-height: 400px;">
                    <div class="tab-pane fade show active" id="tab-profile" role="tabpanel"></div>
                    <div class="tab-pane fade" id="tab-orders" role="tabpanel"></div>
                    <div class="tab-pane fade" id="tab-notes" role="tabpanel"></div>
                    <div class="tab-pane fade" id="tab-meds" role="tabpanel"></div>
                    <div class="tab-pane fade" id="tab-labs" role="tabpanel"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server
    const patientsDB = <%- JSON.stringify(patients) %>;
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ HN ‡∏á‡πà‡∏≤‡∏¢‡πÜ
    const mockDB = patientsDB.reduce((acc, p) => {
        acc[p.hn] = p;
        return acc;
    }, {});

    let mainModal;
    document.addEventListener('DOMContentLoaded', function() {
        mainModal = new bootstrap.Modal(document.getElementById("mainModal"));
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å Tab
    function openPatientData(hn) {
        const data = mockDB[hn];
        if (!data) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Modal
        document.getElementById('modalTitle').innerText = data.name;
        document.getElementById('modalSubtitle').innerText = `HN: ${hn} | AN: ${data.an} | ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á: ${data.bed}`;

        // 2. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Tab (HTML Injection)

        // --- Tab 1: Profile ---
        document.getElementById('tab-profile').innerHTML = `
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="text-primary mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ Admit</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏Ç‡πâ:</strong> ${data.doctor}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit:</strong> ${data.admitDate}</p>
                            <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${data.age} ‡∏õ‡∏µ</p>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <strong>Diagnosis (Dx):</strong> ${data.dx}
                            </div>
                            <div class="alert alert-info py-2">
                                <strong>Vital Signs:</strong> ${data.vitals}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- Tab 2: Orders ---
        document.getElementById('tab-orders').innerHTML = `
            <h5 class="text-primary mb-3">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå (Doctor's Order)</h5>
            <div class="bg-white rounded shadow-sm p-3">
                <table class="table table-striped mb-0">
                    <thead class="table-primary">
                        <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
                    </thead>
                    <tbody>
                        ${data.orders.map(o => `
                            <tr>
                                <td>${o.date}</td>
                                <td><span class="badge ${o.type === 'Continue' ? 'bg-warning text-dark' : 'bg-success'}">${o.type}</span></td>
                                <td>${o.item}</td>
                                <td><i class="bi bi-check-circle-fill text-success"></i> ${o.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        // --- Tab 3: Notes ---
        document.getElementById('tab-notes').innerHTML = `
            <h5 class="text-primary mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (Nurse Note)</h5>
            <div class="bg-white rounded shadow-sm p-3">
                <table class="table table-hover mb-0">
                    <thead class="table-info">
                        <tr><th style="width:15%">‡πÄ‡∏ß‡∏•‡∏≤</th><th style="width:20%">Focus</th><th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (SOAP)</th><th>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th></tr>
                    </thead>
                    <tbody>
                        ${data.nurseNotes.map(n => `
                            <tr>
                                <td>${n.time}</td>
                                <td class="fw-bold text-primary">${n.focus}</td>
                                <td>${n.text}</td>
                                <td class="text-muted small">${n.recorder}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        // --- Tab 4: Meds ---
        document.getElementById('tab-meds').innerHTML = `
            <h5 class="text-primary mb-3">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏¢‡∏≤ (Medication Administration Record)</h5>
            <div class="bg-white rounded shadow-sm p-3">
                <table class="table table-bordered mb-0 align-middle">
                    <thead class="bg-light">
                        <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</th><th>‡∏Ç‡∏ô‡∏≤‡∏î/‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr>
                    </thead>
                    <tbody>
                        ${data.medication.map(m => `
                            <tr>
                                <td class="fw-bold">${m.name}</td>
                                <td>${m.dose} <br><small class="text-muted">${m.route}</small></td>
                                <td>${m.time}</td>
                                <td><span class="badge bg-secondary">${m.last_given}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        // --- Tab 5: Labs ---
        document.getElementById('tab-labs').innerHTML = `
            <h5 class="text-primary mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Lab Results)</h5>
            ${data.lab.map(l => `
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold border-bottom">${l.name}</div>
                    <div class="card-body p-0">
                        <table class="table mb-0">
                            <thead><tr><th>Test</th><th>Result</th><th>Unit</th><th>Flag</th></tr></thead>
                            <tbody>
                                ${l.items.map(i => `
                                    <tr class="${i.flag.includes('(L)') || i.flag.includes('(H)') ? 'table-danger' : ''}">
                                        <td>${i.test}</td>
                                        <td class="fw-bold">${i.result}</td>
                                        <td>${i.unit}</td>
                                        <td>${i.flag}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('')}
        `;

        // 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Tab ‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏°‡∏≠ (Profile) ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
        const firstTabEl = document.querySelector('#patientTabs button[data-bs-target="#tab-profile"]');
        const firstTab = new bootstrap.Tab(firstTabEl);
        firstTab.show();

        // 4. ‡πÅ‡∏™‡∏î‡∏á Modal
        mainModal.show();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.getElementById("search").addEventListener("keyup", function() {
        let v = this.value.toLowerCase();
        document.querySelectorAll("#tableBody tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(v) ? "" : "none";
        });
    });
</script>